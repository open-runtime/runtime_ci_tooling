{{=<% %>=}}
# Generated by runtime_ci_tooling v<%tooling_version%>
# Configured via .runtime_ci/config.json — run 'dart run runtime_ci_tooling:manage_cicd update --workflows' to regenerate.
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.bot_check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Check for release bot commit
        id: bot_check
        run: |
          AUTHOR=$(git log -1 --format='%an')
          MSG=$(git log -1 --format='%s')
          echo "Commit author: $AUTHOR"
          echo "Commit subject: $MSG"
          if [[ "$AUTHOR" == "github-actions[bot]" ]] || [[ "$MSG" == *"[skip ci]"* ]]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Release bot commit detected — skipping CI."
          else
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          fi

  analyze-and-test:
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
<%#has_secrets%>
    env:
<%#secrets_list%>
      <%env_name%>: ${{ secrets.<%secret_name%> }}
<%/secrets_list%>
<%/has_secrets%>
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
<%#lfs%>
          lfs: true
<%/lfs%>

      - name: Configure Git for HTTPS with Token
        shell: bash
        run: |
          TOKEN="${{ secrets.<%pat_secret%> || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/open-runtime/".insteadOf "git@github.com:open-runtime/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/pieces-app/".insteadOf "git@github.com:pieces-app/"

      - uses: dart-lang/setup-dart@v1.7.1
        with:
          sdk: "<%dart_sdk%>"

      - name: Cache Dart pub dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-dart-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-dart-pub-

<%#proto%>
      - name: Install protoc
        uses: arduino/setup-protoc@v3.0.0

      - run: dart pub global activate protoc_plugin 25.0.0

<%/proto%>
      - run: dart pub get

<%#analysis_cache%>
      - name: Cache Dart analysis
        uses: actions/cache@v5.0.3
        with:
          path: ~/.dartServer
          key: ${{ runner.os }}-dart-analysis-${{ hashFiles('**/*.dart', '**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-dart-analysis-

<%/analysis_cache%>
<%#proto%>
      - name: Verify proto files
        run: dart run runtime_ci_tooling:manage_cicd verify-protos

<%/proto%>
<%#managed_analyze%>
      - name: Analyze
        run: dart run runtime_ci_tooling:manage_cicd analyze
<%/managed_analyze%>
<%^managed_analyze%>
      - name: Analyze
        run: |
          dart analyze 2>&1 | tee /tmp/analysis.txt
          if grep -q "^  error -" /tmp/analysis.txt; then
            echo "::error::Analysis errors found"
            exit 1
          fi
<%/managed_analyze%>

<%#sub_packages%>
      - name: Analyze (<%name%>)
        working-directory: <%path%>
        run: |
          dart pub get
          dart analyze 2>&1 | tee /tmp/sub_analysis.txt
          if grep -q "^  error -" /tmp/sub_analysis.txt; then
            echo "::error::Errors found in <%name%>"
            exit 1
          fi

<%/sub_packages%>
<%#format_check%>
      - name: Format check
        run: dart format --line-length <%line_length%> --output=none --set-exit-if-changed lib/

<%/format_check%>
# --- BEGIN USER: pre-test ---
# --- END USER: pre-test ---

<%#managed_test%>
      - name: Test
        run: dart run runtime_ci_tooling:manage_cicd test
<%/managed_test%>
<%^managed_test%>
      - name: Test
        run: dart test
<%/managed_test%>

# --- BEGIN USER: post-test ---
# --- END USER: post-test ---
